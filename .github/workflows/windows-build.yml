name: Windows Build

on:
  push:
    branches:
      - try_github_actions
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      BLENDER_VERSION: "4.5.0-alpha"
      BUILD_TYPE: "Release"

    steps:
      - name: Install Git LFS
        run: git lfs install --skip-repo
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
          lfs: false

      - name: Fetch Main Repository LFS objects
        shell: bash
        run: |
          git config lfs.url https://projects.blender.org/blender/blender.git/info/lfs
          git lfs pull

      - name: Debug - List precompiled libraries content
        shell: pwsh
        run: |
          # Check for the existence and size of a known LFS file
          $oneAPIDLLPath = "lib/windows_x64/cycles/kernel/oneapi/cycles_kernel_oneapi_aot.dll"
          Write-Host "Checking for file: $oneAPIDLLPath"
          if (Test-Path $oneAPIDLLPath) {
            $file = Get-Item $oneAPIDLLPath
            Write-Host "File FOUND: $($file.Name) - Length: $($file.Length) bytes"
            if ($file.Length -lt 500) { # LFS pointer files are typically < 200 bytes
              Write-Warning "File might be an LFS pointer, not the actual binary!"
            }
          } else {
            Write-Error "File NOT FOUND: $oneAPIDLLPath"
          }

          # List the contents of the entire submodule directory (up to 5 levels deep)
          Write-Host "`nListing contents of lib/windows_x64 (recursive up to 5 levels):"
          Get-ChildItem -Path lib/windows_x64 -Recurse -Depth 5 -ErrorAction SilentlyContinue | Select-Object FullName, Length, Attributes | Format-Table -AutoSize
          Write-Host "`nListing .git/modules/lib/windows_x64 (for submodule configuration):"
          Get-ChildItem -Path ./.git/modules/lib/windows_x64 -Recurse -ErrorAction SilentlyContinue | Select-Object FullName, Length, Attributes | Format-Table -AutoSize
        

      - name: Verify datafiles
        shell: pwsh
        run: |
          $f = "release/datafiles/startup.blend"
          if (!(Test-Path $f)) {
            Write-Error "$f not found—check your fork structure!"
            exit 1
          }
          if ((Get-Item $f).Length -lt 10240) {
            Write-Error "$f is too small—still a pointer file?"
            exit 1
          }

      - name: Fetch precompiled libraries
        shell: powershell
        run: python build_files/utils/make_update.py --architecture="amd64"

      - name: Configure CMake
        shell: bash
        run: |
          mkdir build_windows && cd build_windows
          cmake .. \
            -C "../build_files/buildbot/config/blender_windows.cmake" \
            -G "Visual Studio 17 2022" \
            -A x64 \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -D WITH_INSTALL_PORTABLE=ON

      - name: Build and Install
        shell: bash
        run: |
          cd build_windows
          cmake --build . --config ${{ env.BUILD_TYPE }} --target install --parallel

      - name: Verify installation
        shell: pwsh
        run: |
          if (-not (Test-Path "install/blender.exe")) {
            Write-Error "blender.exe missing!"
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-${{ env.BLENDER_VERSION }}
          path: install
