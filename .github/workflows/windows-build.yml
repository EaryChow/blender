# .github/workflows/windows-build.yml
name: Windows Build

on:
  push:
    branches:
      - try_custom_cmp_node  # your branch
  workflow_dispatch:       # manual trigger

jobs:
  build-windows:
    name: Build Blender on Windows
    runs-on: windows-latest

    env:
      BLENDER_VERSION: "4.5.0-alpha"
      BUILD_TYPE: "Release"

    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Init & update submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Configure with Blender's Windows CMake config
        shell: bash
        run: |
          mkdir -p build_windows
          cd build_windows
          # Point CMake at the Blender-provided Windows setup file:
          cmake .. \
            -C ../build_files/buildbot/config/blender_windows.cmake \
            -G Ninja \
            -A x64 \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build with Ninja
        shell: bash
        run: |
          cmake --build . --config ${{ env.BUILD_TYPE }} --parallel

      - name: Package build output
        shell: bash
        run: |
          cd bin/${{ env.BUILD_TYPE }}
          powershell -Command "Compress-Archive -Path * -DestinationPath $Env:GITHUB_WORKSPACE/blender-windows-${{ env.BLENDER_VERSION }}.zip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: blender-windows-${{ env.BLENDER_VERSION }}
          path: blender-windows-${{ env.BLENDER_VERSION }}.zip
